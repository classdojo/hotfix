// Generated by CoffeeScript 1.4.0
(function() {
  var fs, pubnub, _;

  _ = require("underscore");

  fs = require("fs");

  pubnub = require("pubnub");

  /*
   This module is accessible throught the command line, and allows for changes
   to be sent to any connected client to the pubnub hotfix_refresh channel
  */


  exports.require = ["celeri", "pubsub.pubnub"];

  exports.plugin = function(celeri, pubnubClient, loader) {
    return celeri.option({
      command: "push OR push-changes",
      description: "Pushes changes to all clients that are currently viewing the site",
      optional: {
        config: "Configuration file for pubnub.",
        filter: "mongodb-style filter for each client",
        message: "Message to display to the client.",
        interval: "The interval in MS to randomize page refreshes",
        critical: "Critical update - user account is force refreshed."
      },
      defaults: _.extend({
        message: "New updates are available for this page.",
        interval: 1000 * 60,
        critical: false
      }, loader.params("data"))
    }, function(data) {
      if (data.filter) {
        data.filter = JSON.parse(data.filter);
      }
      console.log("refreshing all connected clients");
      return pubnubClient.publish({
        channel: "hotfix_refresh",
        message: {
          text: data.message,
          filter: data.filter,
          critical: data.critical,
          interval: data.interval
        }
      });
    });
  };

}).call(this);
